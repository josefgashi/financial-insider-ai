<div id="news-and-calendar">
    <div id="news-feed"></div>
    <div id="economic-sidebar">
        <div class="sidebar-header">
            <span class="header-title">News</span>
            <span class="header-date" id="calendar-date"></span>
        </div>
        <div id="economic-events"></div>
    </div>
</div>
<div id="refresh-indicator" class="refresh-indicator">Refreshing news...</div>

<style>
body {
    background: #ffffff;
}

#news-and-calendar {
    max-width: 1400px;
    margin: 20px auto;
    padding: 0 40px;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    align-items: start;
}

#news-feed {
    grid-column: 1 / 4;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    row-gap: 24px;
    align-items: start;
}

#economic-sidebar {
    grid-column: 4;
    grid-row: 1 / 10;
    background: #ffffff;
    border-left: 1px solid #e0e0e0;
    padding: 0 0 0 20px;
    position: sticky;
    top: 20px;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
}

.news-card {
    background: transparent;
    padding: 0;
    margin: 0;
    transition: opacity 0.2s;
    align-self: start;
    display: flex;
    flex-direction: column;
}

.news-card:hover {
    opacity: 0.7;
}

.news-card:nth-child(2),
.news-card:nth-child(4) {
    grid-column: span 2;
}

.news-card:nth-child(2) .news-headline,
.news-card:nth-child(4) .news-headline {
    font-size: 24px;
    line-height: 1.2;
}

.news-card:nth-child(2) .news-summary,
.news-card:nth-child(4) .news-summary {
    font-size: 15px;
}

.news-headline {
    font-family: Georgia, 'Times New Roman', serif;
    font-size: 17px;
    font-weight: 700;
    margin: 0 0 6px 0 !important;
    padding: 0 !important;
    line-height: 1.2;
    color: #000000;
}

.news-headline a {
    color: #000000;
    text-decoration: none;
    transition: color 0.2s;
}

.news-headline a:hover {
    color: #2e6da4;
}

.news-summary {
    font-family: Georgia, serif;
    color: #333333;
    font-size: 14px;
    line-height: 1.35;
    margin-bottom: 8px;
    font-weight: 400;
}

.news-meta {
    display: flex;
    gap: 6px;
    align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 11px;
    color: #888888;
}

.news-source {
    font-weight: 600;
    color: #666666;
    font-size: 11px;
}

.news-time {
    color: #999999;
    font-size: 11px;
}

.news-meta-separator {
    width: 3px;
    height: 3px;
    background: #cccccc;
    border-radius: 50%;
}

.sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: 0 0 12px 0;
    margin-bottom: 20px;
    border-bottom: 1px solid #000;
}

.header-title {
    margin: 0;
    font-family: Retina, Helvetica, Arial, sans-serif;
    font-size: 24px;
    line-height: 28px;
    font-weight: 500;
    letter-spacing: 0px;
    font-style: normal;
    text-transform: none;
    padding: 0.5px 0px;
    color: #8b6f47;
}

.header-date {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 11px;
    color: #888;
    font-weight: 400;
}

.economic-event {
    padding: 0 0 20px 0;
    margin-bottom: 20px;
    border-bottom: 1px solid #e8e8e8;
    transition: opacity 0.2s;
}

.economic-event:hover {
    opacity: 0.7;
}

.economic-event:last-child {
    border-bottom: none;
}

.event-title-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 4px;
}

.importance-dot {
    width: 8px;
    height: 14px;
    border-radius: 2px;
    flex-shrink: 0;
    margin-top: 2px;
}

.importance-high {
    background-color: #dc3545;
}

.importance-medium {
    background-color: #ffc107;
}

.importance-low {
    background-color: #999999;
}

.event-title {
    font-family: Georgia, serif;
    font-size: 15px;
    font-weight: 700;
    color: #000;
    line-height: 1.3;
    flex: 1;
}

.event-meta {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 11px;
    color: #666;
}

.news-loading, .events-loading {
    text-align: center;
    padding: 40px 20px;
    color: #999;
    font-size: 14px;
    font-family: Georgia, serif;
}

.news-error {
    text-align: center;
    padding: 80px 20px;
    color: #cc0000;
    font-size: 16px;
    font-family: Georgia, serif;
}

.refresh-indicator {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #000;
    color: #fff;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 1000;
}

.refresh-indicator.show {
    opacity: 0.8;
}

@media (max-width: 1200px) {
    #news-and-calendar {
        grid-template-columns: 1fr;
    }

    #news-feed {
        grid-column: 1;
        grid-template-columns: repeat(2, 1fr);
    }

    #economic-sidebar {
        grid-column: 1;
        grid-row: auto;
        position: relative;
        top: 0;
        max-height: none;
        order: -1;
        margin-bottom: 30px;
        border-left: none;
        border-top: 1px solid #e0e0e0;
        padding: 20px 0 0 0;
    }

    .news-card:nth-child(2),
    .news-card:nth-child(4) {
        grid-column: span 1;
    }
}

@media (max-width: 768px) {
    #news-and-calendar {
        padding: 0 20px;
    }

    #news-feed {
        grid-template-columns: 1fr;
        gap: 24px;
    }
}
</style>

<script>
let refreshInterval;

async function loadEconomicEvents() {
    const container = document.getElementById('economic-events');
    const dateElement = document.getElementById('calendar-date');

    const today = new Date();
    const dateStr = today.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
    });
    dateElement.textContent = dateStr;

    container.innerHTML = '<div class="events-loading">Loading events...</div>';

    try {
        const response = await fetch('https://financial-insider-ai.vercel.app/api/forex-factory');
        const data = await response.json();

        if (data.error || !data.events || data.events.length === 0) {
            container.innerHTML = '<div class="events-loading">No major events scheduled</div>';
            return;
        }

        container.innerHTML = data.events.map(event => `
            <div class="economic-event">
                <div class="event-title-row">
                    <div class="event-title">${event.title}</div>
                    <span class="importance-dot importance-${event.importance}"></span>
                </div>
                <div class="event-meta">${event.time} â€¢ ${event.currency}</div>
            </div>
        `).join('');

    } catch (error) {
        console.error('Economic calendar error:', error);
        container.innerHTML = '<div class="events-loading">Unable to load events</div>';
    }
}

async function loadNews(showIndicator = false) {
    const container = document.getElementById('news-feed');
    const indicator = document.getElementById('refresh-indicator');

    if (showIndicator) {
        indicator.classList.add('show');
    } else {
        container.innerHTML = '<div class="news-loading">Loading the latest financial news...</div>';
    }

    try {
        const response = await fetch('https://financial-insider-ai.vercel.app/api/news');
        const data = await response.json();

        if (data.error) {
            container.innerHTML = '<div class="news-error">Unable to load news. Please refresh the page.</div>';
            return;
        }

        const articles = data.articles.slice(0, 10);

        container.className = '';
        container.innerHTML = articles.map(article => `
            <div class="news-card">
                <h3 class="news-headline">
                    <a href="${article.link}" target="_blank" rel="noopener noreferrer">${article.headline}</a>
                </h3>
                <p class="news-summary">${article.summary}</p>
                <div class="news-meta">
                    <span class="news-source">${article.source}</span>
                    <span class="news-meta-separator"></span>
                    <span class="news-time">${article.timeAgo}</span>
                </div>
            </div>
        `).join('');

        if (showIndicator) {
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

    } catch (error) {
        console.error('News fetch error:', error);
        if (!showIndicator) {
            container.innerHTML = '<div class="news-error">Unable to load news. Please refresh the page.</div>';
        }
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        loadNews();
        loadEconomicEvents();
        refreshInterval = setInterval(() => loadNews(true), 300000);
    });
} else {
    loadNews();
    loadEconomicEvents();
    refreshInterval = setInterval(() => loadNews(true), 300000);
}

window.addEventListener('beforeunload', () => {
    if (refreshInterval) clearInterval(refreshInterval);
});
</script>
